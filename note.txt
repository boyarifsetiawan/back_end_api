# Laravel: Models, Migrations, Factories, Seeders, Controllers, Resources, Repositories, Services, ERD

Dokumen ini berisi seluruh kode yang diminta: **Model**, **Migration**, **Factory**, **Seeder**, **Controller CRUD**, **API Resource**, **Repository Pattern**, **Service Layer**, dan **ERD**. Struktur dan konvensi mengikuti Laravel 10+.

---

## Struktur folder (ringkasan)

```
app/
  Models/
    User.php
    Category.php
    Product.php
    ProductColor.php
    ProductImage.php
    ProductSize.php
    Order.php
    OrderedProduct.php
    OrderStatus.php

  Repositories/
    UserRepository.php
    ProductRepository.php
    OrderRepository.php

  Services/
    UserService.php
    ProductService.php
    OrderService.php

  Http/
    Controllers/
      Api/
        UserController.php
        CategoryController.php
        ProductController.php
        OrderController.php
    Resources/
      UserResource.php
      CategoryResource.php
      ProductResource.php
      OrderResource.php

database/
  migrations/
  factories/
  seeders/

routes/api.php
```

---

# 1. MIGRATIONS

### 1.1 `create_users_table.php`

```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('users', function (Blueprint $table) {
            $table->id('user_id');
            $table->string('first_name');
            $table->string('last_name');
            $table->string('email')->unique();
            $table->string('image')->nullable();
            $table->tinyInteger('gender');
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('users');
    }
};
```

### 1.2 `create_categories_table.php`

```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('categories', function (Blueprint $table) {
            $table->uuid('category_id')->primary();
            $table->string('title');
            $table->string('image')->nullable();
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('categories');
    }
};
```

### 1.3 `create_products_table.php`

```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('products', function (Blueprint $table) {
            $table->uuid('product_id')->primary();
            $table->uuid('category_id');
            $table->decimal('discounted_price', 12, 2)->nullable();
            $table->tinyInteger('gender');
            $table->decimal('price', 12, 2);
            $table->unsignedInteger('sales_number')->default(0);
            $table->string('title');
            $table->timestamp('created_date')->nullable();
            $table->timestamps();

            $table->foreign('category_id')->references('category_id')->on('categories')->cascadeOnDelete();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('products');
    }
};
```

### 1.4 `create_product_images_table.php`

```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('product_images', function (Blueprint $table) {
            $table->id();
            $table->uuid('product_id');
            $table->string('url');
            $table->timestamps();

            $table->foreign('product_id')->references('product_id')->on('products')->cascadeOnDelete();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('product_images');
    }
};
```

### 1.5 `create_product_sizes_table.php`

```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('product_sizes', function (Blueprint $table) {
            $table->id();
            $table->uuid('product_id');
            $table->string('size');
            $table->timestamps();

            $table->foreign('product_id')->references('product_id')->on('products')->cascadeOnDelete();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('product_sizes');
    }
};
```

### 1.6 `create_product_colors_table.php`

```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('product_colors', function (Blueprint $table) {
            $table->id();
            $table->uuid('product_id');
            $table->string('title');
            $table->json('rgb');
            $table->timestamps();

            $table->foreign('product_id')->references('product_id')->on('products')->cascadeOnDelete();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('product_colors');
    }
};
```

### 1.7 `create_orders_table.php`

```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('orders', function (Blueprint $table) {
            $table->uuid('code')->primary();
            $table->unsignedBigInteger('user_id');
            $table->string('shipping_address');
            $table->unsignedInteger('item_count');
            $table->decimal('total_price', 12, 2);
            $table->timestamp('created_date')->nullable();
            $table->timestamps();

            $table->foreign('user_id')->references('user_id')->on('users')->cascadeOnDelete();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('orders');
    }
};
```

### 1.8 `create_ordered_products_table.php`

```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('ordered_products', function (Blueprint $table) {
            $table->id();
            $table->uuid('order_code');
            $table->uuid('product_id');
            $table->unsignedInteger('quantity');
            $table->decimal('price', 12, 2);
            $table->string('color')->nullable();
            $table->string('size')->nullable();
            $table->timestamps();

            $table->foreign('order_code')->references('code')->on('orders')->cascadeOnDelete();
            $table->foreign('product_id')->references('product_id')->on('products')->cascadeOnDelete();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('ordered_products');
    }
};
```

### 1.9 `create_order_statuses_table.php`

```php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('order_statuses', function (Blueprint $table) {
            $table->id();
            $table->uuid('order_code');
            $table->enum('status', ['pending','paid']);
            $table->timestamp('created_date')->nullable();
            $table->timestamps();

            $table->foreign('order_code')->references('code')->on('orders')->cascadeOnDelete();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('order_statuses');
    }
};
```

---

# 2. MODELS

### 2.1 `App\Models\User.php`

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class User extends Model
{
    protected $primaryKey = 'user_id';
    public $incrementing = true;

    protected $fillable = ['first_name','last_name','email','image','gender'];

    public function orders()
    {
        return $this->hasMany(Order::class, 'user_id');
    }
}
```

### 2.2 `App\Models\Category.php`

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Category extends Model
{
    protected $primaryKey = 'category_id';
    public $incrementing = false;
    protected $keyType = 'string';

    protected $fillable = ['title','image'];

    public function products()
    {
        return $this->hasMany(Product::class, 'category_id');
    }
}
```

### 2.3 `App\Models\Product.php`

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Product extends Model
{
    protected $primaryKey = 'product_id';
    public $incrementing = false;
    protected $keyType = 'string';

    protected $fillable = ['product_id','category_id','discounted_price','gender','price','sales_number','title','created_date'];

    protected $casts = ['created_date' => 'datetime'];

    public function category() { return $this->belongsTo(Category::class, 'category_id'); }
    public function colors() { return $this->hasMany(ProductColor::class, 'product_id'); }
    public function images() { return $this->hasMany(ProductImage::class, 'product_id'); }
    public function sizes() { return $this->hasMany(ProductSize::class, 'product_id'); }
}
```

### 2.4 `App\Models\ProductColor.php`

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class ProductColor extends Model
{
    protected $fillable = ['product_id','title','rgb'];
    protected $casts = ['rgb' => 'array'];

    public function product() { return $this->belongsTo(Product::class, 'product_id'); }
}
```

### 2.5 `App\Models\ProductImage.php`

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class ProductImage extends Model
{
    protected $fillable = ['product_id','url'];
    public function product() { return $this->belongsTo(Product::class, 'product_id'); }
}
```

### 2.6 `App\Models\ProductSize.php`

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class ProductSize extends Model
{
    protected $fillable = ['product_id','size'];
    public function product() { return $this->belongsTo(Product::class, 'product_id'); }
}
```

### 2.7 `App\Models\Order.php`

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Order extends Model
{
    protected $primaryKey = 'code';
    public $incrementing = false;
    protected $keyType = 'string';

    protected $fillable = ['code','user_id','shipping_address','item_count','total_price','created_date'];
    protected $casts = ['created_date' => 'datetime'];

    public function user() { return $this->belongsTo(User::class, 'user_id'); }
    public function products() { return $this->hasMany(OrderedProduct::class, 'order_code'); }
    public function statuses() { return $this->hasMany(OrderStatus::class, 'order_code'); }
}
```

### 2.8 `App\Models\OrderedProduct.php`

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class OrderedProduct extends Model
{
    protected $fillable = ['order_code','product_id','quantity','price','color','size'];

    public function order() { return $this->belongsTo(Order::class, 'order_code'); }
    public function product() { return $this->belongsTo(Product::class, 'product_id'); }
}
```

### 2.9 `App\Models\OrderStatus.php`

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class OrderStatus extends Model
{
    protected $fillable = ['order_code','status','created_at'];
    protected $casts = ['created_at' => 'datetime'];

    public function order() { return $this->belongsTo(Order::class, 'order_code'); }
}
```

---

# 3. FACTORIES

> Semua factories menggunakan Faker. Untuk `uuid` gunakan `\Illuminate\Support\Str::uuid()` atau `\Str::uuid()`.

### 3.1 `UserFactory`

```php
namespace Database\Factories;

use App\Models\User;
use Illuminate\Database\Eloquent\Factories\Factory;

class UserFactory extends Factory
{
    protected $model = User::class;

    public function definition()
    {
        return [
            'first_name' => \$this->faker->firstName(),
            'last_name' => \$this->faker->lastName(),
            'email' => \$this->faker->unique()->safeEmail(),
            'image' => null,
            'gender' => \$this->faker->numberBetween(0,1),
        ];
    }
}
```

### 3.2 `CategoryFactory`

```php
namespace Database\Factories;

use App\Models\Category;
use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Str;

class CategoryFactory extends Factory
{
    protected $model = Category::class;

    public function definition()
    {
        return [
            'category_id' => (string) Str::uuid(),
            'title' => \$this->faker->word(),
            'image' => null,
        ];
    }
}
```

### 3.3 `ProductFactory`

```php
namespace Database\Factories;

use App\Models\Product;
use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Str;

class ProductFactory extends Factory
{
    protected $model = Product::class;

    public function definition()
    {
        return [
            'product_id' => (string) Str::uuid(),
            'category_id' => null, // set in seeder or state
            'discounted_price' => \$this->faker->optional()->randomFloat(2, 10, 200),
            'gender' => \$this->faker->numberBetween(0,1),
            'price' => \$this->faker->randomFloat(2, 10, 500),
            'sales_number' => \$this->faker->numberBetween(0,1000),
            'title' => \$this->faker->sentence(3),
            'created_date' => now(),
        ];
    }
}
```

### 3.4 `ProductColorFactory`

```php
namespace Database\Factories;

use App\Models\ProductColor;
use Illuminate\Database\Eloquent\Factories\Factory;

class ProductColorFactory extends Factory
{
    protected $model = ProductColor::class;

    public function definition()
    {
        return [
            'title' => \$this->faker->colorName(),
            'rgb' => [\$this->faker->numberBetween(0,255), \$this->faker->numberBetween(0,255), \$this->faker->numberBetween(0,255)],
        ];
    }
}
```

### 3.5 `ProductImageFactory`

```php
namespace Database\Factories;

use App\Models\ProductImage;
use Illuminate\Database\Eloquent\Factories\Factory;

class ProductImageFactory extends Factory
{
    protected $model = ProductImage::class;

    public function definition()
    {
        return [ 'url' => \$this->faker->imageUrl(640,480) ];
    }
}
```

### 3.6 `ProductSizeFactory`

```php
namespace Database\Factories;

use App\Models\ProductSize;
use Illuminate\Database\Eloquent\Factories\Factory;

class ProductSizeFactory extends Factory
{
    protected $model = ProductSize::class;

    public function definition()
    {
        return [ 'size' => \$this->faker->randomElement(['XS','S','M','L','XL']) ];
    }
}
```

### 3.7 `OrderFactory`

```php
namespace Database\Factories;

use App\Models\Order;
use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Str;

class OrderFactory extends Factory
{
    protected $model = Order::class;

    public function definition()
    {
        return [
            'code' => (string) Str::uuid(),
            'user_id' => null,
            'shipping_address' => \$this->faker->address(),
            'item_count' => 0,
            'total_price' => 0,
            'created_date' => now(),
        ];
    }
}
```

### 3.8 `OrderedProductFactory`

```php
namespace Database\Factories;

use App\Models\OrderedProduct;
use Illuminate\Database\Eloquent\Factories\Factory;

class OrderedProductFactory extends Factory
{
    protected $model = OrderedProduct::class;

    public function definition()
    {
        return [
            'product_id' => null,
            'quantity' => \$this->faker->numberBetween(1,5),
            'price' => \$this->faker->randomFloat(2, 5, 200),
            'color' => null,
            'size' => null,
        ];
    }
}
```

### 3.9 `OrderStatusFactory`

```php
namespace Database\Factories;

use App\Models\OrderStatus;
use Illuminate\Database\Eloquent\Factories\Factory;

class OrderStatusFactory extends Factory
{
    protected $model = OrderStatus::class;

    public function definition()
    {
        return [ 'status' => 'pending', 'created_at' => now() ];
    }
}
```

---

# 4. SEEDERS

### `DatabaseSeeder.php` (ringkasan)

```php
public function run()
{
    \App\Models\User::factory(10)->create()->each(function(\$user){
        // create categories and products globally or separately
    });

    \App\Models\Category::factory(5)->create()->each(function(\$category){
        \App\Models\Product::factory(6)->state(['category_id' => \$category->category_id])->create()->each(function(\$product){
            // images
            \App\Models\ProductImage::factory(3)->state(['product_id' => \$product->product_id])->create();
            // sizes
            \App\Models\ProductSize::factory(3)->state(['product_id' => \$product->product_id])->create();
            // colors
            \App\Models\ProductColor::factory(2)->state(['product_id' => \$product->product_id])->create();
        });
    });

    // Create orders
    \App\Models\Order::factory(15)->create()->each(function(\$order){
        // pick random user
        \$user = \App\Models\User::inRandomOrder()->first();
        \$order->user_id = \$user->user_id;
        \$order->save();

        // add 1-4 ordered products
        \$products = \App\Models\Product::inRandomOrder()->take(rand(1,4))->get();
        \$itemCount = 0; \$total = 0;
        foreach(\$products as \$p){
            \$qty = rand(1,3);
            \$price = (float) \$p->price;
            \$itemCount += \$qty;
            \$total += \$qty * \$price;

            \App\Models\OrderedProduct::factory()->state([
                'order_code' => \$order->code,
                'product_id' => \$p->product_id,
                'quantity' => \$qty,
                'price' => \$price,
                'color' => \$p->colors()->exists() ? \$p->colors()->inRandomOrder()->first()->title : null,
                'size' => \$p->sizes()->exists() ? \$p->sizes()->inRandomOrder()->first()->size : null,
            ])->create();
        }

        \$order->item_count = \$itemCount;
        \$order->total_price = \$total;
        \$order->save();

        // initial status pending
        \App\Models\OrderStatus::factory()->state(['order_code' => \$order->code, 'status' => 'pending'])->create();

        // optionally mark some as paid
        if(rand(0,1)){
            \App\Models\OrderStatus::factory()->state(['order_code' => \$order->code, 'status' => 'paid'])->create();
        }
    });
}
```

---

# 5. API RESOURCES

### 5.1 `UserResource`

```php
namespace App\Http\Resources;

use Illuminate\Http\Resources\Json\JsonResource;

class UserResource extends JsonResource
{
    public function toArray(\$request)
    {
        return [
            'id' => \$this->user_id,
            'first_name' => \$this->first_name,
            'last_name' => \$this->last_name,
            'email' => \$this->email,
            'image' => \$this->image,
        ];
    }
}
```

### 5.2 `CategoryResource`

```php
namespace App\Http\Resources;

use Illuminate\Http\Resources\Json\JsonResource;

class CategoryResource extends JsonResource
{
    public function toArray(\$request)
    {
        return [ 'id' => \$this->category_id, 'title' => \$this->title, 'image' => \$this->image ];
    }
}
```

### 5.3 `ProductResource`

```php
namespace App\Http\Resources;

use Illuminate\Http\Resources\Json\JsonResource;

class ProductResource extends JsonResource
{
    public function toArray(\$request)
    {
        return [
            'id' => \$this->product_id,
            'title' => \$this->title,
            'price' => (float)\$this->price,
            'discounted_price' => (float)\$this->discounted_price,
            'gender' => \$this->gender,
            'sales_number' => \$this->sales_number,
            'category' => new CategoryResource(\$this->whenLoaded('category')),
            'images' => \$this->images->pluck('url'),
            'sizes' => \$this->sizes->pluck('size'),
            'colors' => \$this->colors->map(fn(\$c)=>['title'=>\$c->title,'rgb'=>\$c->rgb]),
        ];
    }
}
```

### 5.4 `OrderResource`

```php
namespace App\Http\Resources;

use Illuminate\Http\Resources\Json\JsonResource;

class OrderResource extends JsonResource
{
    public function toArray(\$request)
    {
        return [
            'code' => \$this->code,
            'user' => new UserResource(\$this->whenLoaded('user')),
            'shipping_address' => \$this->shipping_address,
            'item_count' => \$this->item_count,
            'total_price' => (float)\$this->total_price,
            'created_date' => \$this->created_date?->toDateTimeString(),
            'products' => \$this->products->map(fn(\$p)=>[
                'product_id' => \$p->product_id,
                'quantity' => \$p->quantity,
                'price' => (float)\$p->price,
                'color' => \$p->color,
                'size' => \$p->size,
                'product' => new ProductResource(\$p->product)
            ]),
            'status_timeline' => \$this->statuses->map(fn(\$s)=>['status'=>\$s->status,'created_at'=>\$s->created_at?->toDateTimeString()]),
        ];
    }
}
```

---

# 6. REPOSITORIES (pattern dasar)

### 6.1 `App\Repositories\ProductRepository.php`

```php
namespace App\Repositories;

use App\Models\Product;

class ProductRepository
{
    public function getAll(array \$filters = []){
        return Product::with(['images','sizes','colors','category'])->paginate(12);
    }

    public function findById(string \$id){
        return Product::with(['images','sizes','colors','category'])->findOrFail(\$id);
    }

    public function create(array \$data){
        return Product::create(\$data);
    }

    public function update(string \$id, array \$data){
        \$p = Product::findOrFail(\$id);
        \$p->update(\$data);
        return \$p;
    }

    public function delete(string \$id){
        \$p = Product::findOrFail(\$id);
        return \$p->delete();
    }
}
```

### 6.2 `App\Repositories\OrderRepository.php`

```php
namespace App\Repositories;

use App\Models\Order;

class OrderRepository
{
    public function paginate() { return Order::with(['user','products.product','statuses'])->paginate(12); }
    public function find(string \$code) { return Order::with(['user','products.product','statuses'])->findOrFail(\$code); }
    public function create(array \$data){ return Order::create(\$data); }
    public function update(string \$code, array \$data){ \$o = Order::findOrFail(\$code); \$o->update(\$data); return \$o; }
}
```

### 6.3 `App\Repositories\UserRepository.php`

```php
namespace App\Repositories;

use App\Models\User;

class UserRepository
{
    public function all(){ return User::all(); }
    public function find(int \$id){ return User::findOrFail(\$id); }
    public function create(array \$data){ return User::create(\$data); }
}
```

---

# 7. SERVICES (business logic)

### 7.1 `App\Services\OrderService.php`

```php
namespace App\Services;

use App\Repositories\OrderRepository;
use App\Models\OrderStatus;
use App\Models\OrderedProduct;
use Illuminate\Support\Str;

class OrderService
{
    protected \$repo;
    public function __construct(OrderRepository \$repo){ \$this->repo = \$repo; }

    public function createOrder(array \$payload){
        // payload keys: user_id, shipping_address, products: [{product_id, quantity, price, color, size}]
        \$code = (string) Str::uuid();
        \$itemCount = array_sum(array_map(fn(\$p)=>\$p['quantity'], \$payload['products']));
        \$total = array_sum(array_map(fn(\$p)=>\$p['quantity'] * \$p['price'], \$payload['products']));

        \$order = \$this->repo->create([
            'code' => \$code,
            'user_id' => \$payload['user_id'],
            'shipping_address' => \$payload['shipping_address'],
            'item_count' => \$itemCount,
            'total_price' => \$total,
            'created_date' => now(),
        ]);

        foreach(\$payload['products'] as \$p){
            OrderedProduct::create([
                'order_code' => \$code,
                'product_id' => \$p['product_id'],
                'quantity' => \$p['quantity'],
                'price' => \$p['price'],
                'color' => \$p['color'] ?? null,
                'size' => \$p['size'] ?? null,
            ]);
        }

        // initial status = pending
        OrderStatus::create(['order_code' => \$code, 'status' => 'pending', 'created_at' => now()]);

        return \$order;
    }

    public function markPaid(string \$code){
        \$order = \$this->repo->find(\$code);
        OrderStatus::create(['order_code' => \$code, 'status' => 'paid', 'created_at' => now()]);
        return \$order;
    }
}
```

---

# 8. CONTROLLERS (API simple CRUD)

### 8.1 `ProductController` (ringkasan)

```php
namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Repositories\ProductRepository;
use App\Http\Resources\ProductResource;
use Illuminate\Http\Request;
use Illuminate\Support\Str;

class ProductController extends Controller
{
    protected \$repo;
    public function __construct(ProductRepository \$repo){ \$this->repo = \$repo; }

    public function index(Request \$r){
        return ProductResource::collection(\$this->repo->getAll());
    }

    public function show(string \$id){
        return new ProductResource(\$this->repo->findById(\$id));
    }

    public function store(Request \$r){
        \$data = \$r->only(['category_id','discounted_price','gender','price','sales_number','title']);
        \$data['product_id'] = (string) Str::uuid();
        \$product = \$this->repo->create(\$data);
        return new ProductResource(\$product);
    }

    public function update(Request \$r, string \$id){
        \$product = \$this->repo->update(\$id, \$r->all());
        return new ProductResource(\$product);
    }

    public function destroy(string \$id){ \$this->repo->delete(\$id); return response()->noContent(); }
}
```

### 8.2 `OrderController` (create + markPaid + show)

```php
namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Services\OrderService;
use App\Http\Resources\OrderResource;
use Illuminate\Http\Request;

class OrderController extends Controller
{
    protected \$service;
    public function __construct(OrderService \$service){ \$this->service = \$service; }

    public function store(Request \$r){
        \$payload = \$r->validate([
            'user_id' => 'required|integer',
            'shipping_address' => 'required|string',
            'products' => 'required|array|min:1',
            'products.*.product_id' => 'required|string',
            'products.*.quantity' => 'required|integer|min:1',
            'products.*.price' => 'required|numeric|min:0',
        ]);

        \$order = \$this->service->createOrder(\$payload);
        return new OrderResource(\$order->load(['products.product','statuses','user']));
    }

    public function markPaid(string \$code){
        \$order = \$this->service->markPaid(\$code);
        return new OrderResource(\$order->load(['products.product','statuses','user']));
    }

    public function show(string \$code){
        // fetch via repo inside service or repository
        return new OrderResource(\App\Models\Order::with(['products.product','statuses','user'])->findOrFail(\$code));
    }
}
```

---

# 9. ROUTES (api.php)

```php
use App\Http\Controllers\Api\ProductController;
use App\Http\Controllers\Api\OrderController;

Route::apiResource('products', ProductController::class);
Route::post('orders', [OrderController::class, 'store']);
Route::get('orders/{code}', [OrderController::class,'show']);
Route::post('orders/{code}/pay', [OrderController::class,'markPaid']);
```

---

# 10. ERD (Entity Relationship Description)

* **users (user_id)** 1 --- * **orders (code)**

  * users have many orders; orders belong to user.

* **categories (category_id)** 1 --- * **products (product_id)**

  * product belongsTo category.

* **products (product_id)** 1 --- * **product_images**

* **products (product_id)** 1 --- * **product_sizes**

* **products (product_id)** 1 --- * **product_colors**

* **orders (code)** 1 --- * **ordered_products**

* **orders (code)** 1 --- * **order_statuses**

Fields note: `product_colors.rgb` stored as JSON array of three ints [r,g,b].

---

# 11. Cara pakai (commands)

1. Jalankan migration:

```
php artisan migrate
```

2. Jalankan seeder:

```
php artisan db:seed
```

3. Jika ingin memaksa fresh dan seed:

```
php artisan migrate:fresh --seed
```

4. Gunakan API endpoints (example):

* `POST /api/orders` payload sesuai yang di-validate pada OrderController
* `POST /api/orders/{code}/pay` untuk menambah status `paid`

---

# 12. Catatan tambahan

* Semua UUID di-generate saat create (Category/Product/Order). Jika ingin auto-generate di model, tambahkan trait boot method untuk `creating` event.
* Untuk production, pertimbangkan memakai indexing, pagination tuning, dan audit log untuk order status changes.
* Jika mau, aku bisa juga generate file-file PHP fisiknya di satu zip yang siap di-paste ke proyekmu.

---

Kalau kamu mau, aku bisa juga:

* Buatkan file-file controller lengkap dengan request validation classes.
* Buatkan trait UUID otomatis untuk models.
* Buatkan ERD visual (gambar) yang bisa diunduh.
